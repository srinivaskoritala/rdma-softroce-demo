#!/bin/bash

# RDMA RoCEv2 Demo Script (Simplified Version)
# This script demonstrates the RDMA application structure and functionality

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
echo -e "${BLUE}‚ïë                RDMA RoCEv2 Application Demo                 ‚ïë${NC}"
echo -e "${BLUE}‚ïë                    (Simplified Version)                     ‚ïë${NC}"
echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
echo ""

# Function to print step headers
print_step() {
    echo -e "${CYAN}Step $1: $2${NC}"
    echo "----------------------------------------"
}

# Function to wait for user input
wait_for_user() {
    echo -e "${YELLOW}Press Enter to continue...${NC}"
    read -r
}

# Step 1: Check requirements
print_step "1" "Checking System Requirements"
echo "Checking for RDMA libraries and required tools..."

if make check-requirements; then
    echo -e "${GREEN}‚úì All requirements satisfied${NC}"
else
    echo -e "${YELLOW}‚ö† Some requirements not met (expected in virtual environment)${NC}"
    echo "This demo will show the application structure and functionality"
fi

wait_for_user

# Step 2: Show application architecture
print_step "2" "Application Architecture"
echo "The RDMA application consists of:"
echo ""
echo "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    RDMA RoCEv2     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
echo "‚îÇ   RDMA Client   ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ   RDMA Server   ‚îÇ"
echo "‚îÇ                 ‚îÇ    (Port 18515)    ‚îÇ                 ‚îÇ"
echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"
echo "         ‚îÇ                                       ‚îÇ"
echo "         ‚ñº                                       ‚ñº"
echo "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
echo "‚îÇ Packet Capture  ‚îÇ                    ‚îÇ Throughput      ‚îÇ"
echo "‚îÇ (tcpdump)       ‚îÇ                    ‚îÇ Monitor         ‚îÇ"
echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"
echo ""
echo "Features:"
echo "  ‚Ä¢ RDMA Write operations with 1MB buffers"
echo "  ‚Ä¢ Real-time packet capture and analysis"
echo "  ‚Ä¢ Throughput monitoring and statistics"
echo "  ‚Ä¢ Performance measurement and reporting"

wait_for_user

# Step 3: Show source code structure
print_step "3" "Source Code Structure"
echo "Application files:"
echo ""
echo "üìÅ RDMA Core Application:"
echo "  üìÑ rdma_server.c          - RDMA server implementation"
echo "  üìÑ rdma_client.c          - RDMA client implementation"
echo "  üìÑ rdma_server_simple.c   - Simplified server (this demo)"
echo "  üìÑ rdma_client_simple.c   - Simplified client (this demo)"
echo ""
echo "üìÅ Monitoring & Analysis:"
echo "  üìÑ capture_rdma_traffic.sh - Packet capture script"
echo "  üìÑ throughput_monitor.py   - Throughput monitoring tool"
echo ""
echo "üìÅ Build & Test System:"
echo "  üìÑ Makefile               - Build system"
echo "  üìÑ run_test.sh            - Complete test runner"
echo "  üìÑ demo.sh                - Interactive demo"
echo "  üìÑ demo_simple.sh         - This simplified demo"
echo ""
echo "üìÅ Documentation:"
echo "  üìÑ README.md              - Complete documentation"
echo "  üìÑ requirements.txt       - Python dependencies"

wait_for_user

# Step 4: Show build system
print_step "4" "Build System"
echo "Building simplified RDMA application..."

# Compile the simplified versions
echo "Compiling simplified server..."
gcc -Wall -Wextra -O2 -g -o rdma_server_simple rdma_server_simple.c -libverbs

echo "Compiling simplified client..."
gcc -Wall -Wextra -O2 -g -o rdma_client_simple rdma_client_simple.c -libverbs

if [ -f "rdma_server_simple" ] && [ -f "rdma_client_simple" ]; then
    echo -e "${GREEN}‚úì Build successful${NC}"
    echo "Created executables:"
    echo "  - rdma_server_simple"
    echo "  - rdma_client_simple"
else
    echo -e "${RED}‚úó Build failed${NC}"
    echo "This is expected in a virtual environment without RDMA hardware"
fi

wait_for_user

# Step 5: Show monitoring tools
print_step "5" "Monitoring Tools"
echo "Demonstrating monitoring capabilities..."

# Create results directory
mkdir -p demo_results
cd demo_results

echo "Starting throughput monitoring simulation..."
python3 ../throughput_monitor.py -d 10 -o demo_throughput.json &
MONITOR_PID=$!
sleep 2

echo "Starting packet capture simulation..."
if [ "$EUID" -eq 0 ]; then
    ../capture_rdma_traffic.sh capture &
    CAPTURE_PID=$!
    sleep 2
    echo -e "${GREEN}‚úì Monitoring tools started${NC}"
else
    echo -e "${YELLOW}‚ö† Skipping packet capture (requires root)${NC}"
    echo -e "${GREEN}‚úì Throughput monitoring started${NC}"
fi

wait_for_user

# Step 6: Show application execution
print_step "6" "Application Execution"
echo "Running RDMA application simulation..."

echo "Starting RDMA server simulation..."
echo "Note: In a real environment, this would establish RDMA connections"
echo ""

# Simulate server startup
echo "RDMA RoCEv2 Server Starting..."
echo "Note: This is a simplified demo version"
echo "Using device: mlx5_0 (simulated)"
echo "Port state: Active (simulated)"
echo "RDMA connection established (simulated)"
echo ""

# Simulate client execution
echo "Starting RDMA client simulation..."
echo "RDMA RoCEv2 Client Starting..."
echo "Note: This is a simplified demo version"
echo "Connecting to server at 127.0.0.1:18515 (simulated)"
echo "Using device: mlx5_0 (simulated)"
echo "Port state: Active (simulated)"
echo "Connected to RDMA server at 127.0.0.1:18515 (simulated)"
echo ""

# Simulate RDMA operations
echo "Starting RDMA operations..."
echo "This would perform 100 RDMA write operations with 1MB buffers"
echo ""

# Simulate progress
for i in {0..100..10}; do
    if [ $i -eq 0 ]; then
        echo -n "Progress: "
    fi
    echo -n "‚ñà"
    sleep 0.1
done
echo ""

echo ""
echo "=== RDMA Performance Results (Simulated) ==="
echo "Operations completed: 100"
echo "Total bytes transferred: 104857600"
echo "Elapsed time: 2.345 seconds"
echo "Throughput: 3574.23 Mbps"
echo "Throughput: 446.78 MB/s"
echo ""

wait_for_user

# Step 7: Show monitoring results
print_step "7" "Monitoring Results"
echo "Analyzing monitoring data..."

# Wait for monitoring to complete
wait $MONITOR_PID 2>/dev/null || true

if [ "$EUID" -eq 0 ] && [ -n "$CAPTURE_PID" ]; then
    kill $CAPTURE_PID 2>/dev/null || true
    wait $CAPTURE_PID 2>/dev/null || true
fi

echo ""
echo -e "${BLUE}Throughput Analysis:${NC}"
if [ -f "demo_throughput.json" ]; then
    echo "Throughput monitoring data collected:"
    echo "  - Real-time network statistics"
    echo "  - Send/Receive rate measurements"
    echo "  - Peak, average, and minimum rates"
    echo "  - Total data transferred"
    echo ""
    echo "Sample analysis results:"
    echo "  Send Rate Average: 1500.00 Mbps"
    echo "  Receive Rate Average: 1200.00 Mbps"
    echo "  Total Rate Average: 2700.00 Mbps"
    echo "  Peak Throughput: 3500.00 Mbps"
else
    echo "Throughput monitoring completed"
fi

echo ""
echo -e "${BLUE}Packet Capture Analysis:${NC}"
if [ -f "rdma_analysis.txt" ]; then
    echo "Packet capture analysis:"
    cat rdma_analysis.txt
elif [ -f "rdma_capture.pcap" ]; then
    echo "Packet capture file created: rdma_capture.pcap"
    echo "Analysis would include:"
    echo "  - RoCEv2 packet analysis (UDP port 4791)"
    echo "  - RDMA CM packet analysis (port 18515)"
    echo "  - Packet size distribution"
    echo "  - Timing and latency measurements"
else
    echo "Packet capture simulation completed"
    echo "In a real environment, this would capture:"
    echo "  - RoCEv2 traffic (UDP port 4791)"
    echo "  - RDMA connection management traffic"
    echo "  - Performance and timing data"
fi

wait_for_user

# Step 8: Show advanced features
print_step "8" "Advanced Features"
echo "The complete RDMA application includes:"
echo ""
echo "üîß RDMA Operations:"
echo "  ‚Ä¢ RDMA Write operations"
echo "  ‚Ä¢ RDMA Read operations"
echo "  ‚Ä¢ Atomic operations"
echo "  ‚Ä¢ Memory registration and deregistration"
echo "  ‚Ä¢ Queue pair management"
echo ""
echo "üìä Performance Monitoring:"
echo "  ‚Ä¢ Real-time throughput measurement"
echo "  ‚Ä¢ Latency analysis"
echo "  ‚Ä¢ Packet-level traffic analysis"
echo "  ‚Ä¢ Statistical performance reporting"
echo ""
echo "üõ†Ô∏è Development Features:"
echo "  ‚Ä¢ Comprehensive error handling"
echo "  ‚Ä¢ Signal handling and cleanup"
echo "  ‚Ä¢ Configurable buffer sizes"
echo "  ‚Ä¢ Multiple operation types"
echo "  ‚Ä¢ Detailed logging and debugging"

wait_for_user

# Step 9: Show usage examples
print_step "9" "Usage Examples"
echo "How to use the complete RDMA application:"
echo ""
echo "1. Build the application:"
echo "   make all"
echo ""
echo "2. Run complete test suite:"
echo "   sudo ./run_test.sh"
echo ""
echo "3. Run interactive demo:"
echo "   sudo ./demo.sh"
echo ""
echo "4. Manual execution:"
echo "   # Terminal 1: Start server"
echo "   ./rdma_server"
echo "   # Terminal 2: Start client"
echo "   ./rdma_client"
echo "   # Terminal 3: Monitor traffic"
echo "   sudo ./capture_rdma_traffic.sh capture"
echo ""
echo "5. Throughput monitoring:"
echo "   python3 throughput_monitor.py -d 60 -o results.json"

wait_for_user

# Step 10: Summary
print_step "10" "Demo Summary"
echo -e "${GREEN}Demo completed successfully!${NC}"
echo ""
echo "Generated files in demo_results/:"
ls -la demo_results/ 2>/dev/null || echo "No files generated (expected in virtual environment)"

echo ""
echo "Key features demonstrated:"
echo "  ‚úì RDMA RoCEv2 application architecture"
echo "  ‚úì Client-server communication model"
echo "  ‚úì Performance monitoring capabilities"
echo "  ‚úì Packet capture and analysis"
echo "  ‚úì Build system and automation"
echo "  ‚úì Comprehensive documentation"

echo ""
echo -e "${CYAN}Next steps:${NC}"
echo "  ‚Ä¢ Deploy on RDMA-capable hardware for real testing"
echo "  ‚Ä¢ Modify buffer sizes and operation counts"
echo "  ‚Ä¢ Add additional RDMA operations (READ, ATOMIC)"
echo "  ‚Ä¢ Integrate with specific application requirements"
echo "  ‚Ä¢ Analyze captured packets with Wireshark"

echo ""
echo -e "${BLUE}Thank you for exploring the RDMA RoCEv2 application!${NC}"
echo ""
echo "For more information, see README.md"
